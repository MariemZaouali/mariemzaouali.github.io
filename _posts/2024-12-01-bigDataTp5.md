---
layout: post
title: TP5 Lambda Architecture
subtitle: Cinquième TP
tags: [Big Data, Spark Streaming, Kafka, Spring ]
author: Mariem ZAOUALI
---
# TP5 : Création d'application Big Data Scalable en suivant l'architecture Lambda

>Objectif:
>Ce TP vient compléter les briques développées dans le TP précédent dans l'objectif de développer une application scalable se basant sur l'architecture Lambda.
>Nous avons déjà développé la partie Spark Streaming, l'ingestion des données avec Kafka et le stockage à l'aide de Cassandra.

## Ajout du traitement en lots

Ajoutons au projet `spark-processor`, au niveau du package `processor`, la classe `BatchProcessor.java`:
```java

import java.util.List;
import java.util.Properties;

import org.apache.spark.SparkConf;
import org.apache.spark.api.java.JavaRDD;
import org.apache.spark.api.java.JavaSparkContext;
import org.apache.spark.sql.SparkSession;


public class BatchProcessor {
	
	public static void main(String[] args) throws Exception {

		String file = "spark-processor.properties";
		Properties prop = PropertyFileReader.readPropertyFile(file);
		SparkConf conf = ProcessorUtils.getSparkConf(prop);
		JavaSparkContext sc = new JavaSparkContext(conf);
		
        SparkSession sparkSession = SparkSession.builder().config(conf).getOrCreate();
        
		String saveFile = prop.getProperty("com.iot.app.hdfs") + "iot-data";

		List<AverageData> average_data_list = ProcessorUtils.runBatch(sparkSession, saveFile);
		
		JavaRDD<AverageData> h = sc.parallelize(average_data_list, 1); // transform to RDD
		ProcessorUtils.saveAvgToCassandra(h);

		sparkSession.close();
		sparkSession.stop();

	}

}

```

## Ajout de la couche Serving layer

Maintenant, nous allons créer l'application `dashbord` sur un IDE de votre choix. Commençons par `pom.xml`.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		 xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.1.2.RELEASE</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
    <groupId>com.bigdata.dashboard</groupId>
    <artifactId>dashboard</artifactId>
    <version>1.0.0</version>
    <name>Spring Boot Dashboard</name>

    <!-- Import dependency management from Spring Boot -->

    <properties>
		<java.version>1.8</java.version>
	</properties>

	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-websocket</artifactId>
			<exclusions>
				<exclusion>
					<groupId>org.springframework.boot</groupId>
					<artifactId>spring-boot-starter-logging</artifactId>
				</exclusion>
			</exclusions>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-cassandra</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>

    </dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                </configuration>
            </plugin>
        </plugins>
	</build>

</project>
```

Créez les packages suivants:
-  entity
-  repository
-  utils

Dans le package `entity`, créez les classes suivantes:
```java
import com.fasterxml.jackson.annotation.JsonFormat;
import org.springframework.data.cassandra.core.cql.PrimaryKeyType;
import org.springframework.data.cassandra.core.mapping.Column;
import org.springframework.data.cassandra.core.mapping.PrimaryKeyColumn;
import org.springframework.data.cassandra.core.mapping.Table;

import java.io.Serializable;
import java.util.Date;

@Table("averagedata")
public class AverageData implements Serializable {

	@PrimaryKeyColumn(name = "id", ordinal = 0, type = PrimaryKeyType.PARTITIONED)
	private String id;

	@Column(value = "temperature")
	private double temperature;

	@Column(value = "humidity")
	private double humidity;

	public String getId() {
		return id;
	}

	public double getTemperature() {
		return temperature;
	}

	public double getHumidity() {
		return humidity;
	}


	@Override
	public String toString() {
		return "AverageData [id=" + id + ", temperature=" + temperature + ", humidity=" + humidity  +" ]";
	}

}
```
Puis, la classe suivante:
```java

import com.fasterxml.jackson.annotation.JsonFormat;
import org.springframework.data.cassandra.core.cql.PrimaryKeyType;
import org.springframework.data.cassandra.core.mapping.Column;
import org.springframework.data.cassandra.core.mapping.PrimaryKeyColumn;
import org.springframework.data.cassandra.core.mapping.Table;

import java.io.Serializable;
import java.util.Date;

@Table("humidity")
public class Humidity implements Serializable {
	
	@PrimaryKeyColumn(name = "id", ordinal = 0, type = PrimaryKeyType.PARTITIONED)
	private String id;

	@Column(value = "value")
	private double value;
	
	@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss", timezone = "MST")
	@Column(value = "timestamp")
	private Date timeStamp;

	public String getId() {
		return id;
	}

	public void setId(String id) {
		this.id = id;
	}

	public double getValue() {
		return value;
	}

	public void setValue(double value) {
		this.value = value;
	}

	public Date getTimeStamp() {
		return timeStamp;
	}

	public void setTimeStamp(Date timeStamp) {
		this.timeStamp = timeStamp;
	}

	@Override
	public String toString() {
		return "Humidity [id=" + id + ", value=" + value + ", timeStamp=" + timeStamp + "]";
	}

}
```
Puis, la classe:
```java


import com.fasterxml.jackson.annotation.JsonFormat;
import org.springframework.data.cassandra.core.cql.PrimaryKeyType;
import org.springframework.data.cassandra.core.mapping.Column;
import org.springframework.data.cassandra.core.mapping.PrimaryKeyColumn;
import org.springframework.data.cassandra.core.mapping.Table;

import java.io.Serializable;
import java.util.Date;


@Table("temperature")
public class Temperature implements Serializable{
	
	@PrimaryKeyColumn(name = "id", ordinal = 0, type = PrimaryKeyType.PARTITIONED)
	private String id;

	@Column(value = "value")
	private double value;
	
	@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss", timezone = "MST")
	@Column(value = "timestamp")
	private Date timeStamp;

	public String getId() {
		return id;
	}

	public void setId(String id) {
		this.id = id;
	}

	public double getValue() {
		return value;
	}

	public void setValue(double value) {
		this.value = value;
	}

	public Date getTimeStamp() {
		return timeStamp;
	}

	public void setTimeStamp(Date timeStamp) {
		this.timeStamp = timeStamp;
	}

	@Override
	public String toString() {
		return "Temperature [id=" + id + ", value=" + value + ", timeStamp=" + timeStamp + "]";
	}
	
	
}
```
Dans le package `repository`, créez les classes suivantes:
```java


import org.springframework.data.cassandra.repository.CassandraRepository;
import org.springframework.data.cassandra.repository.Query;
import org.springframework.stereotype.Repository;

import com.bigdata.dashboard.entity.AverageData;


@Repository
public interface AverageDataRepository extends CassandraRepository<AverageData,String>{
	
	@Query("SELECT * FROM sensordatakeyspace.averagedata")
	 AverageData find();
	

}
```
Puis , la classe suivante:
```java


import org.springframework.data.cassandra.repository.CassandraRepository;
import org.springframework.data.cassandra.repository.Query;
import org.springframework.stereotype.Repository;

import com.bigdata.dashboard.entity.Humidity;

import java.util.Date;
import java.util.UUID;


@Repository
public interface HumidityRepository extends CassandraRepository<Humidity,UUID>{
	
	@Query("SELECT * FROM sensordatakeyspace.humidity WHERE timestamp > ?0 ALLOW FILTERING")
	 Iterable<Humidity> findHumidityByDate(Date date);

}
```

Puis la classe suivante:
```java


import org.springframework.data.cassandra.repository.CassandraRepository;
import org.springframework.data.cassandra.repository.Query;
import org.springframework.stereotype.Repository;

import com.bigdata.dashboard.entity.Temperature;

import java.util.Date;
import java.util.UUID;

@Repository
public interface TemperatureRepository extends CassandraRepository<Temperature, UUID>{

	 @Query("SELECT * FROM sensordatakeyspace.temperature WHERE timestamp > ?0 ALLOW FILTERING")
	 Iterable<Temperature> findTemperatureByDate(Date date);
}
```
Le pckage `utils`
la classe `main.java`
L'interface `index.html` et la partie `js`
## A vous de jouer
Cahier de charges pour le projet final
